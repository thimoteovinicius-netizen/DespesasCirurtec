<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Despesas Cirurtec</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:15px;
}
h1{text-align:center;}
.card{
  background:#fff;
  padding:15px;
  border-radius:8px;
  margin-bottom:15px;
}
input,select,button{
  width:100%;
  padding:10px;
  margin-top:8px;
}
button{
  background:#1976d2;
  color:#fff;
  border:none;
  border-radius:6px;
}
.hidden{display:none;}
.despesa{
  border-top:1px solid #ddd;
  margin-top:8px;
  padding-top:8px;
}
</style>
</head>

<body>

<h1>Despesas Cirurtec</h1>

<div class="card">
  <input id="nome" placeholder="Nome do técnico">
  <input id="email" type="email" placeholder="E-mail">
</div>

<div class="card">
  <label>Data inicial</label>
  <input type="date" id="dataInicio">

  <label>Data final</label>
  <input type="date" id="dataFim">

  <input type="number" id="adiantamento" placeholder="Valor do adiantamento (R$)">
</div>

<div class="card">
  <h3>Nova despesa</h3>

  <select id="categoria" onchange="controleCategoria()">
    <option value="">Categoria</option>
    <option>Alimentação</option>
    <option>Bônus de viagem</option>
    <option>Veículo próprio</option>
    <option>Combustível</option>
    <option>Pedágios</option>
    <option>Peças</option>
    <option>Hospedagem</option>
    <option>Outros</option>
  </select>

  <select id="refeicao" class="hidden" onchange="calcularValor()">
    <option value="">Tipo de refeição</option>
    <option>Café da manhã</option>
    <option>Almoço</option>
    <option>Café da tarde</option>
    <option>Jantar</option>
  </select>

  <input type="number" id="quantidade" class="hidden" min="1" placeholder="Quantidade">

  <input id="descricaoLivre" class="hidden" placeholder="Descrição livre">

  <input type="number" id="valorUnit" placeholder="Valor unitário (R$)">

  <button onclick="addDespesa()">Adicionar despesa</button>
</div>

<div class="card">
  <h3>Despesas lançadas</h3>
  <div id="lista"></div>
</div>

<div class="card">
  <button onclick="finalizar()">Finalizar viagem e gerar PDF</button>
</div>

<script>
let despesas = [];

// ===== CONTROLE DE CATEGORIA =====
function controleCategoria(){
  refeicao.classList.add("hidden");
  quantidade.classList.add("hidden");
  descricaoLivre.classList.add("hidden");
  valorUnit.readOnly = false;
  valorUnit.value = "";

  if(categoria.value === "Alimentação"){
    refeicao.classList.remove("hidden");
    quantidade.classList.remove("hidden");
  }

  if(categoria.value === "Bônus de viagem"){
    quantidade.classList.remove("hidden");
    valorUnit.value = 25;
    valorUnit.readOnly = true;
  }

  if(categoria.value === "Veículo próprio"){
    quantidade.classList.remove("hidden");
    valorUnit.value = 1.28;
    valorUnit.readOnly = true;
  }

  if(categoria.value === "Outros"){
    descricaoLivre.classList.remove("hidden");
  }
}

// ===== VALORES FIXOS DE ALIMENTAÇÃO =====
function calcularValor(){
  const valores = {
    "Café da manhã": 10,
    "Almoço": 10,
    "Café da tarde": 10,
    "Jantar": 40
  };
  if(valores[refeicao.value]){
    valorUnit.value = valores[refeicao.value];
    valorUnit.readOnly = true;
  }
}

// ===== ADICIONAR DESPESA =====
function addDespesa(){
  if(!categoria.value || !valorUnit.value){
    alert("Preencha a despesa corretamente");
    return;
  }

  const qtd = Number(quantidade.value) || 1;
  const unit = Number(valorUnit.value);
  const total = qtd * unit;

  despesas.push({
    categoria: categoria.value,
    descricao: descricaoLivre.value || refeicao.value || "",
    quantidade: qtd,
    valorUnit: unit,
    total: total
  });

  lista.innerHTML += `
    <div class="despesa">
      ${categoria.value} ${qtd}x – R$ ${total.toFixed(2)}
    </div>
  `;

  categoria.value = "";
  refeicao.value = "";
  quantidade.value = "";
  descricaoLivre.value = "";
  valorUnit.value = "";
  controleCategoria();
}

// ===== FINALIZAR E GERAR PDF =====
function finalizar(){
  const adiant = Number(adiantamento.value);

  if(isNaN(adiant) || adiant <= 0){
    alert("Informe corretamente o valor do adiantamento");
    return;
  }

  if(despesas.length === 0){
    alert("Nenhuma despesa lançada");
    return;
  }

  const totalGasto = despesas.reduce((s,d)=>s+d.total,0);
  const saldo = adiant - totalGasto;

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 15;

  pdf.setFontSize(12);
  pdf.text("Despesas Cirurtec",10,y); y+=8;
  pdf.setFontSize(10);

  pdf.text(`Técnico: ${nome.value}`,10,y); y+=6;
  pdf.text(`Período: ${dataInicio.value} a ${dataFim.value}`,10,y); y+=6;
  pdf.text(`Valor adiantado: R$ ${adiant.toFixed(2)}`,10,y); y+=8;

  pdf.text("Despesas:",10,y); y+=6;

  despesas.forEach((d,i)=>{
    pdf.text(
      `${i+1}. ${d.categoria} – R$ ${d.total.toFixed(2)}`,
      10, y
    );
    y+=6;
  });

  y+=6;
  pdf.text(`Total gasto: R$ ${totalGasto.toFixed(2)}`,10,y); y+=6;

  if(saldo >= 0){
    pdf.text(`Saldo restante: R$ ${saldo.toFixed(2)}`,10,y);
  } else {
    pdf.text(`Saldo negativo (reembolso): R$ ${Math.abs(saldo).toFixed(2)}`,10,y);
  }

  pdf.save("Despesas_Cirurtec.pdf");

  // Limpar
  despesas = [];
  lista.innerHTML = "";
}
</script>

</body>
</html>
