<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Despesas Cirurtec</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#f4f4f4;padding:15px;}
h1{text-align:center;}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;}
input,select,button,textarea{width:100%;padding:10px;margin-top:8px;}
button{background:#1976d2;color:#fff;border:none;border-radius:6px;}
.btn-sec{background:#455a64;}
.hidden{display:none;}
.despesa{border-top:1px solid #ddd;margin-top:8px;padding-top:8px;}
.anexo{border:1px dashed #aaa;padding:8px;margin-top:8px;font-size:12px;}
img{max-width:100%;border-radius:4px;}
</style>
</head>

<body>

<h1>Despesas Cirurtec</h1>

<div class="card">
  <input id="nome" placeholder="Nome do t√©cnico">
  <input id="email" type="email" placeholder="E-mail">
</div>

<div class="card">
  <label>Data inicial</label>
  <input type="date" id="dataInicio">
  <label>Data final</label>
  <input type="date" id="dataFim">
  <input type="number" id="adiantamento" placeholder="Valor do adiantamento (R$)">
</div>

<div class="card">
  <h3>Nova despesa</h3>

  <select id="categoria" onchange="controleCategoria()">
    <option value="">Categoria</option>
    <option>Alimenta√ß√£o</option>
    <option>B√¥nus de viagem</option>
    <option>Ve√≠culo pr√≥prio</option>
    <option>Combust√≠vel</option>
    <option>Ped√°gios</option>
    <option>Pe√ßas</option>
    <option>Hospedagem</option>
    <option>Outros</option>
  </select>

  <select id="refeicao" class="hidden" onchange="calcularValor()">
    <option value="">Tipo de refei√ß√£o</option>
    <option>Caf√© da manh√£</option>
    <option>Almo√ßo</option>
    <option>Caf√© da tarde</option>
    <option>Jantar</option>
  </select>

  <input type="number" id="quantidade" class="hidden" min="1" placeholder="Quantidade">
  <input id="descricaoLivre" class="hidden" placeholder="Descri√ß√£o livre">
  <input type="number" id="valorUnit" placeholder="Valor unit√°rio (R$)">

  <button onclick="addDespesa()">Adicionar despesa</button>
</div>

<div class="card">
  <h3>Despesas lan√ßadas</h3>
  <div id="lista"></div>
</div>

<div class="card">
  <h3>Anexos da viagem</h3>

  <button class="btn-sec" onclick="camera.click()">üì∏ C√¢mera</button>
  <input type="file" id="camera" accept="image/*" capture="environment" hidden>

  <button class="btn-sec" onclick="galeria.click()">üñºÔ∏è Galeria</button>
  <input type="file" id="galeria" accept="image/*" hidden>

  <textarea id="descAnexo" maxlength="200" placeholder="Descri√ß√£o do anexo"></textarea>
  <button onclick="addAnexo()">Adicionar anexo</button>

  <div id="listaAnexos"></div>
</div>

<div class="card">
  <button onclick="finalizar()">Finalizar viagem e gerar PDF</button>
</div>

<script>
let despesas=[];
let anexos=[];

function formatarData(d){
  if(!d) return "";
  const [y,m,da]=d.split("-");
  return `${da}/${m}/${y}`;
}

function controleCategoria(){
  refeicao.classList.add("hidden");
  quantidade.classList.add("hidden");
  descricaoLivre.classList.add("hidden");
  valorUnit.readOnly=false;
  valorUnit.value="";

  if(categoria.value==="Alimenta√ß√£o"){
    refeicao.classList.remove("hidden");
    quantidade.classList.remove("hidden");
  }
  if(categoria.value==="B√¥nus de viagem"){
    quantidade.classList.remove("hidden");
    valorUnit.value=25;
    valorUnit.readOnly=true;
  }
  if(categoria.value==="Ve√≠culo pr√≥prio"){
    quantidade.classList.remove("hidden");
    valorUnit.value=1.28;
    valorUnit.readOnly=true;
  }
  if(categoria.value==="Outros"){
    descricaoLivre.classList.remove("hidden");
  }
}

function calcularValor(){
  const v={
    "Caf√© da manh√£":10,
    "Almo√ßo":10,
    "Caf√© da tarde":10,
    "Jantar":40
  };
  if(v[refeicao.value]){
    valorUnit.value=v[refeicao.value];
    valorUnit.readOnly=true;
  }
}

function addDespesa(){
  const qtd=Number(quantidade.value)||1;
  const unit=Number(valorUnit.value);
  if(!categoria.value||!unit) return alert("Preencha corretamente");

  const total=qtd*unit;
  despesas.push({
    categoria:categoria.value,
    desc:descricaoLivre.value||refeicao.value||"",
    qtd,unit,total
  });

  lista.innerHTML+=`<div class="despesa">${categoria.value} ‚Äì R$ ${total.toFixed(2)}</div>`;
  categoria.value=refeicao.value=quantidade.value=descricaoLivre.value=valorUnit.value="";
  controleCategoria();
}

function addAnexo(){
  const file=camera.files[0]||galeria.files[0];
  if(!file) return alert("Selecione uma imagem");

  const r=new FileReader();
  r.onload=e=>{
    anexos.push({img:e.target.result,desc:descAnexo.value});
    listaAnexos.innerHTML+=`
      <div class="anexo">
        <img src="${e.target.result}">
        <div>${descAnexo.value||"(sem descri√ß√£o)"}</div>
      </div>`;
    camera.value=galeria.value=descAnexo.value="";
  };
  r.readAsDataURL(file);
}

function borda(pdf){
  pdf.rect(5,5,200,287);
}

function finalizar(){
  const ad=Number(adiantamento.value);
  if(!ad) return alert("Informe o adiantamento");

  const total=despesas.reduce((s,d)=>s+d.total,0);
  const saldo=ad-total;

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=20;

  borda(pdf);

  pdf.setFontSize(16);
  pdf.text("RELAT√ìRIO DE DESPESAS DE VIAGEM",105,y,{align:"center"});
  y+=10;

  pdf.setFontSize(11);
  pdf.text("Empresa: Cirurtec Hospitalar LTDA",10,y); y+=6;
  pdf.text(`T√©cnico: ${nome.value}`,10,y); y+=6;
  pdf.text(`Per√≠odo: ${formatarData(dataInicio.value)} a ${formatarData(dataFim.value)}`,10,y); y+=8;

  pdf.setFontSize(12);
  pdf.text("Resumo Financeiro",10,y); y+=6;
  pdf.setFontSize(11);
  pdf.text(`Valor adiantado: R$ ${ad.toFixed(2)}`,10,y); y+=6;
  pdf.text(`Total gasto: R$ ${total.toFixed(2)}`,10,y); y+=6;

  pdf.setTextColor(saldo<0?255:0, saldo<0?0:128, 0);
  pdf.text(
    saldo<0
      ? `Saldo negativo (reembolso): R$ ${Math.abs(saldo).toFixed(2)}`
      : `Saldo restante: R$ ${saldo.toFixed(2)}`,
    10,y
  );
  pdf.setTextColor(0,0,0);
  y+=10;

  pdf.setFontSize(12);
  pdf.text("Despesas detalhadas",10,y); y+=6;
  pdf.setFontSize(10);

  despesas.forEach((d,i)=>{
    pdf.text(`${i+1}. ${d.categoria} - ${d.desc} | Qtd: ${d.qtd} | Total: R$ ${d.total.toFixed(2)}`,10,y);
    y+=6;
    if(y>260){pdf.addPage();borda(pdf);y=20;}
  });

  if(anexos.length){
    pdf.addPage();borda(pdf);y=20;
    pdf.setFontSize(12);
    pdf.text("Anexos",10,y); y+=10;

    anexos.forEach(a=>{
      if(y>210){pdf.addPage();borda(pdf);y=20;}
      pdf.addImage(a.img,"JPEG",10,y,90,60);
      y+=65;
      if(a.desc){
        pdf.setFontSize(10);
        pdf.text(a.desc,10,y); y+=8;
      }
    });
  }

  pdf.save("Relatorio_Despesas_Cirurtec.pdf");
}
</script>

</body>
</html>
