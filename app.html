<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Despesas Cirurtec</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
h1{text-align:center}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px}
input,select,button,textarea{width:100%;padding:10px;margin-top:8px}
textarea{resize:none}
button{background:#1976d2;color:#fff;border:none;border-radius:6px}
.btn-sec{background:#455a64}
.hidden{display:none}
.despesa{border-top:1px solid #ddd;margin-top:6px;padding-top:6px}
.anexo{border:1px solid #ccc;padding:8px;margin-top:8px;border-radius:6px}
</style>
</head>

<body>

<h1>Despesas Cirurtec</h1>

<datalist id="cidades-mg">
  <option value="Belo Horizonte - MG">
  <option value="Uberl√¢ndia - MG">
  <option value="Uberaba - MG">
  <option value="Juiz de Fora - MG">
  <option value="Divin√≥polis - MG">
  <option value="Sete Lagoas - MG">
  <option value="Montes Claros - MG">
</datalist>

<div class="card">
  <input id="nome" placeholder="Nome do t√©cnico">
  <input id="email" placeholder="E-mail">
</div>

<div class="card">
  <label>Data in√≠cio</label>
  <input type="date" id="dataInicio">
  <label>Data final</label>
  <input type="date" id="dataFim">
  <input type="number" id="adiantamento" placeholder="Valor do adiantamento (R$)">
</div>

<div class="card">
  <h3>Trajeto</h3>
  <input list="cidades-mg" id="origem" placeholder="Ponto inicial">
  <button class="btn-sec" onclick="addParada()">‚ûï Adicionar parada</button>
  <div id="paradas"></div>
  <input list="cidades-mg" id="destino" placeholder="Destino final">
</div>

<div class="card">
  <h3>Nova despesa</h3>

  <select id="categoria" onchange="controleCategoria()">
    <option value="">Categoria</option>
    <option>Alimenta√ß√£o</option>
    <option>B√¥nus de viagem</option>
    <option>Ve√≠culo pr√≥prio</option>
    <option>Combust√≠vel</option>
    <option>Ped√°gios</option>
    <option>Pe√ßas</option>
    <option>Hospedagem</option>
    <option>Outros</option>
  </select>

  <select id="sub" class="hidden" onchange="calcularValor()">
    <option value="">Refei√ß√£o</option>
    <option>Almo√ßo</option>
    <option>Caf√© da tarde</option>
    <option>Jantar</option>
  </select>

  <input type="number" id="qtd" class="hidden" min="1" placeholder="Quantidade" oninput="calcularValor()">
  <input id="outros" class="hidden" placeholder="Descri√ß√£o livre">
  <input id="valor" type="number" placeholder="Valor (R$)" readonly>

  <button onclick="addDespesa()">Adicionar despesa</button>
</div>

<div class="card">
  <h3>Despesas lan√ßadas</h3>
  <div id="lista"></div>
</div>

<div class="card">
  <h3>Anexos</h3>
  <button class="btn-sec" onclick="camera.click()">üì∏ C√¢mera</button>
  <input id="camera" type="file" accept="image/*" capture="environment" multiple hidden>

  <button class="btn-sec" onclick="galeria.click()">üñºÔ∏è Galeria</button>
  <input id="galeria" type="file" accept="image/*" multiple hidden>

  <div id="listaAnexos"></div>
</div>

<div class="card">
  <h3>Observa√ß√µes</h3>
  <textarea id="observacoes" maxlength="500" placeholder="Observa√ß√µes gerais (at√© 500 caracteres)"></textarea>
</div>

<div class="card">
  <button onclick="finalizar()">Finalizar viagem e gerar PDF</button>
</div>

<script>
let despesas = [], anexos = [];

function addParada(){
  const d = document.createElement("div");
  d.innerHTML = `<input list="cidades-mg" placeholder="Cidade de parada">`;
  paradas.appendChild(d);
}

/* === CORRE√á√ÉO DEFINITIVA DE DUPLICA√á√ÉO === */
function processarArquivos(input){
  [...input.files].forEach(f=>{
    const r = new FileReader();
    r.onload = e=>{
      anexos.push({ img: e.target.result, desc: "" });
      renderAnexos();
    };
    r.readAsDataURL(f);
  });
  input.value = "";
}

camera.onchange = () => processarArquivos(camera);
galeria.onchange = () => processarArquivos(galeria);

function renderAnexos(){
  listaAnexos.innerHTML="";
  anexos.forEach((a,i)=>{
    listaAnexos.innerHTML+=`
      <div class="anexo">
        <img src="${a.img}" width="100%">
        <textarea placeholder="Descri√ß√£o da imagem (opcional)"
          oninput="anexos[${i}].desc=this.value"></textarea>
      </div>`;
  });
}

function controleCategoria(){
  sub.classList.add("hidden");
  qtd.classList.add("hidden");
  outros.classList.add("hidden");
  valor.value="";
  valor.readOnly=true;

  if(categoria.value==="Alimenta√ß√£o"){
    sub.classList.remove("hidden");
    qtd.classList.remove("hidden");
  }

  if(categoria.value==="B√¥nus de viagem" || categoria.value==="Ve√≠culo pr√≥prio"){
    qtd.classList.remove("hidden");
    calcularValor();
  }

  if(categoria.value==="Outros"){
    outros.classList.remove("hidden");
    valor.readOnly=false;
  }

  if(["Combust√≠vel","Ped√°gios","Pe√ßas","Hospedagem"].includes(categoria.value)){
    valor.readOnly=false;
  }
}

function calcularValor(){
  const q = Number(qtd.value)||0;
  if(categoria.value==="Alimenta√ß√£o"){
    const t={"Almo√ßo":10,"Caf√© da tarde":10,"Jantar":40};
    if(t[sub.value] && q) valor.value=t[sub.value]*q;
  }
  if(categoria.value==="B√¥nus de viagem" && q) valor.value=25*q;
  if(categoria.value==="Ve√≠culo pr√≥prio" && q) valor.value=(1.28*q).toFixed(2);
}

function addDespesa(){
  if(!categoria.value || !valor.value) return alert("Dados incompletos");
  despesas.push({
    categoria:categoria.value,
    detalhe:sub.value||outros.value||"",
    valor:Number(valor.value)
  });
  lista.innerHTML+=`<div class="despesa">${categoria.value} ‚Äì R$ ${valor.value}</div>`;
  categoria.value=sub.value=qtd.value=outros.value=valor.value="";
  controleCategoria();
}

function finalizar(){
  const ad = Number(adiantamento.value);
  if(!ad) return alert("Informe o adiantamento");

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=10,total=0;

  pdf.text("Cirurtec Hospitalar LTDA",10,y);y+=6;
  pdf.text(`T√©cnico: ${nome.value}`,10,y);y+=6;
  pdf.text(`Trajeto:`,10,y);y+=6;
  pdf.text(`Origem: ${origem.value}`,10,y);y+=6;
  [...paradas.children].forEach((p,i)=>{
    pdf.text(`Parada ${i+1}: ${p.querySelector("input").value}`,10,y);
    y+=6;
  });
  pdf.text(`Destino: ${destino.value}`,10,y);y+=8;

  despesas.forEach(d=>{
    total+=d.valor;
    pdf.text(`${d.categoria} ${d.detalhe} ‚Äì R$ ${d.valor.toFixed(2)}`,10,y);
    y+=6;
  });

  y+=6;
  pdf.text(`Adiantamento: R$ ${ad.toFixed(2)}`,10,y);y+=6;
  pdf.text(`Total gasto: R$ ${total.toFixed(2)}`,10,y);y+=6;
  const saldo = ad - total;
  pdf.text(`Saldo final: R$ ${saldo.toFixed(2)} ${saldo<0?"(NEGATIVO)":"(RESTANTE)"}`,10,y);

  if(observacoes.value){
    y+=8;
    pdf.text("Observa√ß√µes:",10,y);y+=6;
    pdf.text(observacoes.value,10,y,{maxWidth:190});
  }

  if(anexos.length){
    pdf.addPage(); y=10;
    anexos.forEach(a=>{
      if(y>220){pdf.addPage();y=10}
      pdf.addImage(a.img,"JPEG",10,y,80,60);
      if(a.desc){pdf.text(a.desc,10,y+65)}
      y+=75;
    });
  }

  pdf.save("Despesas_Cirurtec.pdf");
}
</script>

</body>
</html>
